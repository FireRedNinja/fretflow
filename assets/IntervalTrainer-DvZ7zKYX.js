import{r as m,j as t}from"./index-DNOtO4WB.js";import{F as le}from"./Fretboard-BdrLPhB4.js";import{S as p,g as w}from"./musicUtils-Bffn_pRB.js";import{I as $,g as ce,a as k,b as ge}from"./intervalUtils-bYTG8tbd.js";const xe=()=>{var G,H,X,J;const[I,O]=m.useState("find"),[g,C]=m.useState("settings"),[n,P]=m.useState(null),[Q,F]=m.useState(""),[W,A]=m.useState(0),[Y,M]=m.useState(0),[Z,y]=m.useState([]),K=["M3","P4","P5","m3","M7","m7"],[l,ee]=m.useState({rootStrings:Array(p.length).fill(!0),rootFretRange:{min:0,max:7},intervals:K,targetConstraint:"any"}),[v,T]=m.useState(l),[U,h]=m.useState(""),z=m.useMemo(()=>p.slice().reverse(),[]),R=12,u=p.length,V=(e,r)=>Math.floor(Math.random()*(r-e+1))+e,q=e=>{if(e.length!==0)return e[Math.floor(Math.random()*e.length)]},_=m.useCallback(()=>{const e=l.rootStrings.map((o,s)=>o?s:-1).filter(o=>o!==-1);if(e.length===0)return h("Please select at least one string for the root note."),null;let r=0;for(;r<50;){r++;const o=e[V(0,e.length-1)],s=V(l.rootFretRange.min,l.rootFretRange.max);if(l.targetConstraint==="nextStringUp"&&o===0||l.targetConstraint==="nextStringDown"&&o===u-1)continue;const a=u-1-o;if(!w(p[a],s))continue;const i=Math.max(0,...l.intervals.map(f=>{var N;return((N=$[f])==null?void 0:N.semitones)??0}));if(!(s>R-3&&i>3))return{string:o,fret:s}}return h("Could not find a suitable root note position. Try adjusting settings."),null},[l,u]),L=(e,r,o)=>{let s=[];switch(o){case"sameString":s=[e.string];break;case"nextStringUp":e.string>0&&(s=[e.string-1]);break;case"nextStringDown":e.string<u-1&&(s=[e.string+1]);break;case"any":default:s=l.rootStrings.map((a,c)=>a?c:-1).filter(a=>a!==-1);break}if(s.length===0)return null;for(const a of s){const c=u-1-a;for(let i=0;i<=R;i++){if(a===e.string&&i===e.fret)continue;if(w(p[c],i)===r)return{string:a,fret:i}}}return null},D=m.useCallback(()=>{if(h(""),l.intervals.length===0){h("Please select at least one interval."),C("settings");return}let e=!1,r=0;for(;!e&&r<50;){r++;const o=_();if(!o){C("settings");return}const s=u-1-o.string,a=w(p[s],o.fret);if(!a){console.error("Failed to calculate root note in generateQuestion.");continue}const c=q(l.intervals),i=c?$[c]:void 0;if(!i||!c){console.error("Invalid interval key selected.");continue}const f=ce(a,i);if(!f){console.error("Failed to calculate target note.");continue}let N=null;if(I==="find")N={mode:"find",rootPosition:o,rootNote:a,targetInterval:i,correctNoteName:f},y([{...o,color:"bg-blue-500",label:a}]),e=!0;else{const x=L(o,f,l.targetConstraint);if(!x)continue;const d=i.shortName,S=k.filter(j=>j.shortName!==d&&l.intervals.includes(j.shortName)).sort(()=>.5-Math.random()).slice(0,3).map(j=>j.shortName),b=new Set([d,...S]);for(;b.size<4&&b.size<l.intervals.length;){const j=q(l.intervals);if(j&&j!==d)b.add(j);else if(b.size<k.length){const E=q(k);E&&E.shortName!==d&&b.add(E.shortName)}else break}const ie=Array.from(b).sort(()=>.5-Math.random());N={mode:"identify",rootPosition:o,rootNote:a,targetInterval:i,intervalNotePosition:x,answerOptions:ie},y([{...o,color:"bg-blue-500",label:a},{...x,color:"bg-yellow-400",label:w(p[u-1-x.string],x.fret)}]),e=!0}e&&N&&(P(N),F(""),C("question"))}e||(h(`Could not generate a valid question with the current constraints after ${r} attempts. Try 'any' constraint or broader settings.`),C("settings"))},[l,I,_,u]),te=e=>{if(g!=="question"||!n||n.mode!=="find"||!n.correctNoteName||!n.rootNote)return;let r=!0,o="";const s=n.rootPosition,a=l.targetConstraint;if(a==="sameString"&&e.string!==s.string?(r=!1,o="Interval must be on the same string."):a==="nextStringUp"&&e.string!==s.string-1?(r=!1,o="Interval must be on the next higher string."):a==="nextStringDown"&&e.string!==s.string+1&&(r=!1,o="Interval must be on the next lower string."),!r){F(o),y(d=>[...d,{...e,color:"bg-gray-400",label:"X"}]),setTimeout(()=>y(d=>d.filter(S=>!(S.string===e.string&&S.fret===e.fret&&S.color==="bg-gray-400"))),1e3);return}const c=u-1-e.string,i=w(p[c],e.fret);if(!i)return;M(d=>d+1);const f=i===n.correctNoteName,N=ge(n.rootNote,i),x=[];if(x.push({...n.rootPosition,color:"bg-blue-300",label:n.rootNote}),f)F(`Correct! That's ${n.targetInterval.name} (${n.targetInterval.shortName}).`),A(d=>d+1),x.push({...e,color:"bg-green-500",label:i});else{const d=N?`${N.name} (${N.shortName})`:"an unknown interval";F(`Incorrect. That was ${i} (${d}). The correct note was ${n.correctNoteName} (${n.targetInterval.shortName}).`),x.push({...e,color:"bg-red-500",label:i});const S=L(s,n.correctNoteName,a);if(S&&!(S.string===e.string&&S.fret===e.fret))x.push({...S,color:"bg-green-200 border border-green-600",label:n.correctNoteName});else if(a!=="any"){const b=L(s,n.correctNoteName,"any");b&&!(b.string===e.string&&b.fret===e.fret)&&x.push({...b,color:"bg-yellow-300 border border-yellow-600",label:n.correctNoteName})}}y(x),C("answered")},ne=e=>{if(g!=="question"||!n||n.mode!=="identify"||!n.intervalNotePosition)return;M(s=>s+1);const r=n.targetInterval.shortName;if(e===r)F("Correct!"),A(s=>s+1),y([{...n.rootPosition,color:"bg-green-500",label:n.rootNote},{...n.intervalNotePosition,color:"bg-green-500",label:w(p[u-1-n.intervalNotePosition.string],n.intervalNotePosition.fret)}]);else{const s=n.targetInterval.name;F(`Incorrect. The interval was ${s} (${r}).`),y([{...n.rootPosition,color:"bg-blue-500",label:n.rootNote},{...n.intervalNotePosition,color:"bg-red-500",label:w(p[u-1-n.intervalNotePosition.string],n.intervalNotePosition.fret)}])}C("answered")},re=e=>{T(r=>{const o=[...r.rootStrings];return o[e]=!o[e],{...r,rootStrings:o}}),h("")},B=e=>{const{name:r,value:o}=e.target,s=parseInt(o,10);isNaN(s)||s<0||s>R||(T(a=>{const c={...a.rootFretRange,[r]:s};return r==="min"&&s>c.max&&(c.max=s),r==="max"&&s<c.min&&(c.min=s),{...a,rootFretRange:c}}),h(""))},se=e=>{T(r=>{const o=new Set(r.intervals);o.has(e)?o.delete(e):o.add(e);const s=Array.from(o).sort((a,c)=>{var i,f;return(((i=$[a])==null?void 0:i.semitones)??0)-(((f=$[c])==null?void 0:f.semitones)??0)});return{...r,intervals:s}}),h("")},oe=e=>{T(r=>({...r,targetConstraint:e.target.value})),h("")},ae=()=>{if(v.rootStrings.filter(Boolean).length===0){h("Select root string(s).");return}if(v.intervals.length===0){h("Select interval(s).");return}if(v.rootFretRange.min>v.rootFretRange.max){h("Min root fret > Max root fret.");return}ee(v),A(0),M(0),F(""),P(null),y([]),h(""),C("idle")};return m.useEffect(()=>{g==="idle"&&D()},[g,D]),t.jsxs("div",{className:"p-4 md:p-6",children:[t.jsx("h1",{className:"text-2xl font-bold mb-1 text-gray-800",children:"Interval Trainer"}),t.jsxs("div",{className:"mb-4 border-b border-gray-300 pb-2",children:[" "," ",t.jsx("label",{children:"Mode:"})," ",t.jsxs("div",{className:"flex space-x-4",children:[" ",t.jsxs("label",{children:[" ",t.jsx("input",{type:"radio",name:"interval_mode",value:"find",checked:I==="find",onChange:()=>O("find"),disabled:g!=="settings"})," Find Note "]})," ",t.jsxs("label",{children:[" ",t.jsx("input",{type:"radio",name:"interval_mode",value:"identify",checked:I==="identify",onChange:()=>O("identify"),disabled:g!=="settings"})," Identify Name "]})," "]})," "]}),t.jsxs("details",{className:"bg-gray-100 border border-gray-300 rounded-lg mb-6 shadow",open:g==="settings",children:[t.jsx("summary",{className:"p-3 font-semibold cursor-pointer hover:bg-gray-200 rounded-t-lg",children:"Practice Settings"}),t.jsxs("div",{className:"p-4 border-t border-gray-300 space-y-4",children:[t.jsxs("fieldset",{className:"border p-3 rounded",children:[" "," ",t.jsx("legend",{children:"Root Note"})," ",t.jsxs("div",{className:"space-y-3 mt-1",children:[" ",t.jsxs("div",{children:[" ",t.jsx("label",{children:"Allowed Strings:"})," ",t.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1",children:[" ",z.map((e,r)=>t.jsxs("label",{children:[" ",t.jsx("input",{type:"checkbox",checked:v.rootStrings[r],onChange:()=>re(r)})," ",t.jsx("span",{className:"text-sm",children:e})," "]},`root-str-${r}`))," "]})," "]})," ",t.jsxs("div",{children:[" ",t.jsx("label",{children:"Fret Range:"})," ",t.jsxs("div",{className:"flex items-center space-x-2",children:[" ",t.jsx("input",{type:"number",name:"min",value:v.rootFretRange.min,onChange:B,min:"0",max:R,className:"w-14 p-1 border rounded text-sm"})," to ",t.jsx("input",{type:"number",name:"max",value:v.rootFretRange.max,onChange:B,min:"0",max:R,className:"w-14 p-1 border rounded text-sm"})," "]})," "]})," "]})," "]}),t.jsxs("fieldset",{className:"border p-3 rounded",children:[" "," ",t.jsx("legend",{children:"Intervals"})," ",t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-1 mt-1",children:[" ",k.sort((e,r)=>e.semitones-r.semitones).map(e=>t.jsxs("label",{children:[" ",t.jsx("input",{type:"checkbox",value:e.shortName,checked:v.intervals.includes(e.shortName),onChange:()=>se(e.shortName)})," ",t.jsx("span",{className:"text-sm",children:`${e.name} (${e.shortName})`})," "]},e.shortName))," "]})," "]}),t.jsxs("fieldset",{className:"border border-gray-300 p-3 rounded",children:[t.jsx("legend",{className:"text-md font-medium px-1 text-gray-700",children:"Interval Location Constraint"}),t.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-2 mt-1",children:["any","sameString","nextStringUp","nextStringDown"].map(e=>t.jsxs("label",{className:"flex items-center space-x-1 cursor-pointer",children:[t.jsx("input",{type:"radio",name:"targetConstraint",value:e,checked:v.targetConstraint===e,onChange:oe,className:"text-blue-600 focus:ring-blue-500 h-4 w-4"}),t.jsx("span",{className:"text-sm",children:e==="any"?"Any String":e==="sameString"?"Same String Only":e==="nextStringUp"?"Next Higher String Only":e==="nextStringDown"?"Next Lower String Only":e})]},e))}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:'"Higher" means lower index (e.g., G to B). "Lower" means higher index (e.g., D to A).'})]}),t.jsxs("div",{className:"pt-3 text-right",children:[" ",U&&t.jsx("p",{className:"text-red-600 text-sm mb-2 text-left",children:U})," ",t.jsx("button",{onClick:ae,className:"py-2 px-5 bg-green-600 text-white rounded hover:bg-green-700 shadow",children:" Apply Settings & Start "})," "]})]})]}),g!=="settings"&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"bg-white p-4 rounded-lg shadow mb-6 min-h-[200px]",children:[g==="idle"&&t.jsx("p",{children:"Loading..."}),n&&(g==="question"||g==="answered")&&t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"text-lg font-semibold mb-3",children:I==="find"?`Find: ${((G=n.targetInterval)==null?void 0:G.name)||"..."} (${((H=n.targetInterval)==null?void 0:H.shortName)||"..."}) above ${n.rootNote}`+(l.targetConstraint!=="any"?` (${l.targetConstraint.replace("String"," string")})`:""):`Identify the interval from ${n.rootNote} to ${w(p[u-1-(((X=n.intervalNotePosition)==null?void 0:X.string)??0)],((J=n.intervalNotePosition)==null?void 0:J.fret)??0)}:`}),t.jsx(le,{highlightedNotes:Z,fretCount:R,tuning:z,onFretClick:g==="question"&&I==="find"?te:void 0})]})]}),g==="question"&&I==="identify"&&(n==null?void 0:n.answerOptions)&&t.jsxs("div",{className:"mb-6",children:[" ",t.jsx("p",{children:"Select interval name:"})," ",t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:[" ",n.answerOptions.map(e=>{const r=$[e];return t.jsxs("button",{onClick:()=>ne(e),className:"w-full text-left py-2 px-3 bg-sky-500 text-white rounded hover:bg-sky-600 shadow text-sm",children:[" ",r?`${r.name} (${r.shortName})`:e," "]},e)})," "]})," "]}),g==="answered"&&t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg shadow mb-6 text-center",children:[" ",t.jsx("p",{className:`text-xl font-bold mb-3 ${Q.includes("Correct")?"text-green-600":"text-red-600"}`,children:Q})," ",t.jsx("button",{onClick:D,className:"py-2 px-5 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow",children:" Next Question "})," "]}),t.jsxs("div",{className:"text-right text-gray-600",children:[" ",t.jsxs("p",{children:["Score: ",W," / ",Y]})," "]})]})]})};export{xe as default};
